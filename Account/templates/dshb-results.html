{% extends 'base2.html' %}
{% load static %}
{% block content %}

  <div class="dashboard__main">
    <div class="dashboard__content bg-light-4" style="padding: 30px 30px;">

      {% include 'messages.html' %}

      <div class="row y-gap-30">
        <div class="col-12">
          <div class="rounded-16 bg-white -dark-bg-dark-1 shadow-4 h-100">
            <div class="tabs -active-purple-2 js-tabs pt-0">
              <div class="tabs__content py-30 px-30 js-tabs-content">

                <div class="tabs__pane -tab-item-1 is-active" data-pane="tab1">
                  <div class="row y-gap-10">
                    <div class="col-auto">
                      <form class="search-field border-light rounded-8 h-50" action="." method="get">
                        <select class="js-example-basic-single" name="state" onchange="this.form.submit()" style="min-width: 200px;">
                          <option value="0" {% if request.GET.state == 0 %}selected{% endif %}>------</option>
                          {% for group in groups %}
                            <option value="{{ group.id }}" {% if group.id|stringformat:"s" == request.GET.state %}selected{% endif %}>{{ group.name|capfirst }}</option>
                          {% endfor %}
                        </select>
                      </form>
                    </div>
                
                    <div class="col-auto">
                      <form class="search-field border-light rounded-8 h-50" action="." method="get">
                        <select class="js-example-basic-single" name="t" onchange="updateUrl(this)" style="min-width: 200px;">
                          <option value="0" {% if request.GET.t == 0 %}selected{% endif %}>------</option>
                          {% for topic in group_topics.all_course_topics.all %}
                            <option value="{{ topic.id }}" {% if topic.id|stringformat:"s" == request.GET.t %}selected{% endif %}>{{ topic.topic_title|capfirst }}</option>
                          {% endfor %}
                        </select>
                      </form>
                    </div>
                  </div>

                  <style>
                    .tDiv{
                      width:100%;
                      overflow-x:scroll;
                      display: flex;
                    }

                    .tc {
                      text-align: center;
                    }

                    table.table td,
                    table.table th {
                      padding: 10px;
                    }

                    .min_w_150 {
                      min-width: 150px;
                    }

                    .tdborderleft {
                      /* border-left: 2px solid #EDEDED; */
                      border-left: 2px solid #B2B2B2;
                    }

                    .tdborderright {
                      /* border-left: 2px solid #EDEDED; */
                      border-right: 2px solid #B2B2B2;
                    }
                  </style>

                  <div class="tDiv py-30">

                    <div class="table-responsive" style="padding-right: 20px;">
                      <table class="table">
                        <thead>
                          <tr>
                            <th>№</th>
                            <th class="min_w_150">Ad Soyad</th>
                            <th>Nəticə</th>
                            <th class="tdborderright">Tarix</th>
                          </tr>
                        </thead>
                        <tbody>

                          {% for result in students_results %}
                            <tr>
                              <td class="tc">{{ forloop.counter }}</td>
                              <td class="min_w_150">{{ result.student.get_full_name|capfirst }}</td>
                              <td class="tc">{{ result.total_point }} bal</td>
                              <td class="tc tdborderright">{{ result.created_at|date:"d.m.Y" }}</td>
                            </tr>
                          {% endfor %}

                        </tbody>
                      </table>
                    </div>

                    <div class="table-responsive">
                      <table class="table">
                        <thead>
                          <tr>
                            {% comment %} <th class="tdborderleft">№</th> {% endcomment %}
                            <th class="min_w_150 tdborderleft">Ad Soyad</th>
                            <th class="min_w_150 tc">Toplam jeton</th>
                            {% for topic in group_topics.all_course_topics.all %}
                              <th class="tc min_w_150">{{ topic.topic_title|capfirst }}</th>
                            {% endfor %}
                          </tr>
                        </thead>
                        <tbody>

                          {% for result in all_results %}
                            <tr>
                              {% comment %} <td class="tc tdborderleft">{{ forloop.counter }}</td> {% endcomment %}
                              <td class="min_w_150 tdborderleft">{{ result.student__first_name|capfirst }} {{ result.student__last_name|capfirst }}</td>
                              <td class="tc">{{ result.avg_total_point }} bal</td>
                              {% for other_topic_result in result.other_topics_total_points %}
                                <td class="tc">{{ other_topic_result }} {% if other_topic_result != '-------' %}bal{% endif %}</td>
                              {% endfor %}
                            </tr>
                          {% endfor %}

                        </tbody>
                      </table>
                    </div>

                  </div>

                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/js/select2.min.js"></script>
  <script>
    $(document).ready(function () {
      $('.js-example-basic-single').select2();
    })
  </script>


<!-- Add this before your closing </body> tag -->
<script>
  $(document).ready(function () {
      function reloadPage() {
          location.reload(); // Force a reload from the server
      }

      // Set the page reload interval (e.g., every 5 seconds)
      setTimeout(reloadPage, 60000);
  });
</script>

<script>
  function updateUrl(element) {
      // Get the value of the selected topic
      var topicValue = element.value;
      
      // Get the current URL
      var currentUrl = new URL(window.location.href);
      
      // Update only the 't' parameter in the URL
      currentUrl.searchParams.set('t', topicValue);
      
      // Redirect to the updated URL
      window.location.href = currentUrl.toString();
  }
</script>
{% endblock %}
